---
title: 'Zero-Cost Hops для избранных маршрутизаторов'
date: 2026-02-06T16:31:52+05:00
draft: false
author: 'Dmitriy Q'
tags: [meshtastic, role, translate]
---

Что если бы сообщения могли проходить через вашу сетевую инфраструктуру в один хоп?
Что, если бы вы могли связать два города в 600 милях друг от друга через LoRa и *все еще* оставались хопы в запасе?
Что делать, если более быстрые настройки требуют в два раза больше хопов, чтобы добраться до друзей, но у вас нет свободных хопов?

Это именно то, что **Zero-Cost Hops** разблокирует для вашей сети.

![Blursed image of a hopscotch game with multiple 3s and 4s written on the squares](https://meshtastic.org/assets/images/zero_cost_hopscotch-d37d0ea2146c46f30f72e4af6b73ec91.png)

## TL;DR

Эта функция улучшает охват сообщений, сохраняя оставшиеся хопы между избранными маршрутизаторами.

## Почему это важно?

- Быстрые предустановки, такие как `SHORT_FAST` и `SHORT_TURBO`, жертвуют дальностью ради скорости. В плотных городских сетях это означает, что 7-хоповый предел можно достичь очень быстро.
- **Хопы без затрат** превращают сеть из тщательно размещённых инфраструктурных маршрутизаторов в один хоп, оставляя больше хопов для первой и последней мили.
- Для хорошо управляемых сетей это может позволить связь между городами или даже странами, оставаясь в пределах 7-хопового лимита.
- Помогает предотвратить превращение `CLIENT_BASE` в последний хоп пакета, чтобы сообщения не «умирали» на крыше до того, как достигнут ваши внутренние ноды.

## Когда применяются Zero-Cost Hops?

Хоп сохраняется, если **все** условия выполняются:

1. Роль узла — `ROUTER`, `ROUTER_LATE` или `CLIENT_BASE`.
2. Это не первый хоп пакета.
3. Предыдущий ретранслятор находится в ваших *избранных* **и** является `ROUTER` или `ROUTER_LATE`.

Если хотя бы одно из условий не выполняется, счетчик хопов уменьшается как обычно.

## На что это не влияет

- Правила ретрансляции `CLIENT_BASE` остаются точно такими же. `CLIENT_BASE` использует `from` / `to`, в то время как Zero-Cost Hops использует `relay_node`.
- Добавление маршрутизатора в избранное **не** заставляет ноды `CLIENT_BASE` ретранслировать все пакеты.
- Максимальное количество хопов по-прежнему равно 7.

Чтобы protobuf-файлы оставались маленькими и экономили память, нода сопоставляет **relay_node** с вашим списком избранного и проверяет, что нода является инфраструктурной.

Используя только 8 бит для relay_node, существует вероятность коллизий.

- Вероятность того, что какая-либо избранная нода совпадёт со случайной нодой, возможна и увеличивается с ростом числа избранного.
- Ноды с совпадениями всё равно должны находиться *в пределах досягаемости* маршрутизатора, чтобы это имело значение.
- Дедупликация предотвращает циклы.
- Случайные совпадения редки и неопасны.

Вероятность коллизии в пробной среде:

| Общее количество нод | Маршрутизаторов   (3% от количества нод) | Избранные маршрутизаторы в зоне досягаемости  (20% от маршрутизаторов) | Вероятность коллизии |
| -------------------- | ---------------------------------------- | ---------------------------------------------------------------------- | -------------------- |
| 10                   | 0.3 (≈1)                                 | 1                                                                      | ~0.4 %               |
| 50                   | 1.5 (≈2)                                 | 1                                                                      | ~0.4 %               |
| 100                  | 3                                        | 1                                                                      | ~0.4 %               |
| 200                  | 6                                        | 2                                                                      | ~0.8 %               |
| 400                  | 12                                       | 3                                                                      | ~1.2 %               |
| 800                  | 24                                       | 5                                                                      | ~2.0 %               |
| 1000                 | 30                                       | 6                                                                      | ~2.3 %               |

*Примечание: «Общее количество нод» — это размер сети; вероятность коллизии рассчитывается на основе числа избранных маршрутизаторов в зоне действия, а не всех нод, делённых на 256. Например, при 1000 нодах и 6 избранных маршрутизаторах вероятность того, что случайная нода-посредник совпадёт с любимой в зоне действия, составляет около 2,3%.*

Вероятность столкновения здесь редка.

## Два быстрых сценария

### 1. Простой пример метро в центре города

**Установка**

- Маршрутизаторы **R1** и **R2** используют роль `ROUTER` и добавлены в избранное (друг для друга).
- Отправитель использует роль `CLIENT` и хочет пообщаться с другом в соседнем городе.

**Маршрут**

`CLIENT → R1 → R2 → CLIENT`

**Маршрут с хопами** начиная с максимума в 4 хопа

| Хоп         | Действие      | Счетчик | Оставшиеся хопы |
| ----------- | ------------- | ------- | --------------- |
| CLIENT → R1 | normal        | –1      | 3               |
| R1 → R2     | **zero-cost** | 0       | 3               |
| R2 → CLIENT | normal        | –1      | 2               |

**Результат:** Хоп между R1 и R2 сохранён, оставляя дополнительный хоп на случай необходимости.

### 2. Домашняя база, возвышенность

**Установка**

- Возвышенные ноды используют роль `CLIENT_BASE` и выбирают в избранные локальные ноды `ROUTER`.
- Каждая нода на возвышенности использует роль `ROUTER` и выбирает друг друга в избранные.
- Все остальные ноды используют роль `CLIENT`.

**Маршрут через ноды** с максимум 7 хопами

| Хоп | Путь                                           | Действие      | Изменение счетчика | Оставшиеся хопы |
| --- | ---------------------------------------------- | ------------- | ------------------ | --------------- |
| 1   | Носимый CLIENT → CLIENT_BASE на крыше          | normal        | –1                 | 6               |
| 2   | CLIENT_BASE на крыше → ROUTER на возвышенности | normal        | –1                 | 5               |
| 3   | ROUTER на возвышенности → ROUTER посередине    | **zero-cost** | 0                  | 5               |
| 4   | ROUTER посередине → Удаленный ROUTER           | **zero-cost** | 0                  | 5               |
| 5   | Удаленный ROUTER → Удаленный CLIENT_BASE       | **zero-cost** | 0                  | 5               |
| 6   | Удаленный CLIENT_BASE → близкий CLIENT         | normal        | –1                 | 4               |
| 7   | близкий CLIENT → CLIENT друг другу             | normal        | –1                 | 3               |
| 8   | CLIENT друг другу → друг CLIENT                | normal        | –1                 | 2               |

Это демонстрирует способность выходить за пределы лимита протокола в 7 хопов

## Как это применить на практике

1. **Назначайте роли осознанно**
- `ROUTER` для мест на возвышенностях.
- `ROUTER_LATE` для заполнения пробелов.
- `CLIENT_BASE` дома; ставьте в избранное свои портативные устройства.

2. **Выбирайте избранное**
Взаимно добавьте в избранное все ноды инфраструктурных маршрутизаторов и добавьте их к вашей крыше-ноде `CLIENT_BASE`.

3. **Тестируйте и отслеживайте**
Запустите traceroute до и после добавления в избранное. Смотрите, как хопы исчезают.

## Системы безопасности по-прежнему действуют

- Раннее/по умолчанию/позднее время выполнения всё ещё действует.
- Устранение дубликатов пакетов работает как ожидается.
- Наиболее эффективно для узлов на больших высотах, поэтому злоупотребления маловероятны при хорошо управляемых сетях.

## FAQ

**Могу ли я увеличить предел количества хопов выше семи?**
Нет, всё ещё семь. Просто каждый хоп даёт больше охвата.

**Разве это не перегрузит сеть?**
Вряд ли, если сеть хорошо управляется.

**Нужны ли изменения прошивки?**
Не для клиентов. Только ноды ROUTER, ROUTER_LATE и CLIENT_BASE нужно обновить до версии не ниже 2.7.11, чтобы поддерживать эту функцию.

**Считается ли `CLIENT_BASE` инфраструктурой?**
Для входящего трафика, полученного от маршрутизаторов, да. Это предотвращает потерю сообщений на крыше до того, как они доберутся до ваших внутренних нод.

**Tracert всё ещё работает?**
Zero-cost hops не влияют на tracert, кроме того, что сам tracert ограничен 7 хопами.
### Пример из реальной жизни

Для Bay Mesh имеется более 700 нод между Тахо и Сан-Луис-Обиспо. При аккуратном размещении маршрутизаторов возможно передавать сообщения на расстояние более 300 миль, что на LoRa достигается только с помощью zero-cost hops, учитывая рельеф и расстояние.

Используя [Meshview](https://github.com/pablorevilla-meshtastic/meshview), размещённый на [bayme.sh](https://meshview.bayme.sh/), вы можете наблюдать работу zero-cost hops между Сан-Франциско, Сан-Луис-Обиспо и Тахо.

![Zero-cost hops mesh view](https://meshtastic.org/assets/images/zero_cost_meshview-8d36c09a1f576738b3174749ee02d06f.webp)

## Готовы к эксперименту?

Выберите две или три стратегических инфраструкрутрные ноды и отметьте их как избранные друг для друга. Наблюдайте, как хопы не расходуются между роутерами. Сделайте то же самое для вашей ноды на крыше `CLIENT_BASE` и получите больше сообщений, чем раньше.

Приятного создания сети. Пусть ваши друзья всегда будут в зоне досягаемости.